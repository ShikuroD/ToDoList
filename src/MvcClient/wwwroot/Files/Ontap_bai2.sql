create database QLSinhVienDB ;
use QLSinhVienDB ;

-- KHOA(MAKHOA, TENKHOA)
create table KHOA(
	MAKHOA int primary key,
	TENKHOA Nvarchar(40)
);

-- GIAOVIEN(MAGV, TENGV, NGAYSINH, DIACHI, DIENTHOAI, TRINHDO, MAKHOA)
create table GIAOVIEN(
	MAGV int primary key,
	TENGV Nvarchar(40),
	NGAYSINH DATE,
	DIACHI NVARCHAR(50),
	DIENTHOAI NVARCHAR(10),
	TRINHDO NVARCHAR(15),
	MAKHOA INT,
	CONSTRAINT GV_FKKHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
);

-- LOP(MALOP, TENLOP, MAGV,MAKHOA)
create table LOP(
	MALOP int primary key,
	TENLOP varchar(40),
	MAGV int,
	MAKHOA INT,
	CONSTRAINT LOP_FKKHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT LOP_FKGV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)
);

-- SINHVIEN(MSSV, HOTEN, NAMSINH, NAMNHAPHOC, MALOP)
CREATE TABLE SINHVIEN(
	MSSV INT PRIMARY KEY,
	HOTEN NVARCHAR(40),
	NAMSINH INT,
	NAMNHAPHOC INT,
	MALOP INT,
	CONSTRAINT SV_FKLOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)
);
-- drop
DROP TABLE SINHVIEN;
drop table LOP;
drop table GIAOVIEN;
drop table KHOA;
GO

-- INSERT INTO
INSERT INTO KHOA(MAKHOA,TENKHOA)
VALUES	(1,'Cong Nghe Thong Tin'),
		(2,'Man Non'),
		(3,'Ngon Ngu Anh'),
		(4,'Toan Ung Dung');

INSERT INTO GIAOVIEN(MAGV, TENGV, NGAYSINH, DIACHI, DIENTHOAI, TRINHDO, MAKHOA)
VALUES  (1,'Hieu', cast('11/12/1980' as date), '111 abc', '0123456789', 'Thac si', 1),
		(2,'Quoc', cast('7/9/1981' as date), '222 def', '0123456788', 'Tien si', 2),
		(3,'Giang', cast('5/4/1990' as date), '333 ebc', '0123456799', 'Thac si', 1),
		(4,'Binh', cast('9/9/1970' as date), '444 dbc', '0123458899', 'Pho Giao Su', 3);

INSERT INTO LOP(MALOP, TENLOP, MAGV,MAKHOA)
VALUES  (1,'cnpm',1,1),
		(2,'cslt',3,1),
		(3,'ky nang noi',3,3),
		(4,'ky nang nghe',3,3),
		(5,'ky nang viet',3,3),
		(6,'piano',2,2),
		(7,'ke chuyen',2,2);

INSERT INTO SINHVIEN(MSSV, HOTEN, NAMSINH, NAMNHAPHOC, MALOP)
VALUES  (1,'Viet',1999, 2017,1),
		(2,'Tien',2000, 2018,1),
		(3,'Sang',1999, 2017,1),
		(4,'Phuong',1999, 2018,3),
		(5,'Vy',1999, 2017,7),
		(6,'Thuy',2000, 2018,5),
		(7,'Trang',2000, 2019,6),
		(8,'Hoang',1999, 2018,2),
		(9,'Vuong',1998, 2016,2);

-- select
SELECT * FROM KHOA;
select * from GIAOVIEN;
SELECT * FROM LOP;
SELECT * FROM SINHVIEN;

-- cau 2 a
IF OBJECT_ID('SP_TONGSINHVIEN', 'P') IS NOT NULL
	DROP PROC SP_TONGSINHVIEN
GO
CREATE PROCEDURE SP_TONGSINHVIEN
	@MALOP INT,
	@TONG INT OUTPUT
AS
	BEGIN
		SET @TONG = (SELECT COUNT(MSSV) 
				FROM SINHVIEN
				WHERE MALOP = @MALOP);
	END
GO

DECLARE @TONG int
EXEC SP_TONGSINHVIEN 4, @TONG output
PRINT @TONG

--cau 2 b


--cau 2 c
ALTER TABLE SINHVIEN
ADD CONSTRAINT CHK_SINHVIEN_AGE CHECK (NAMNHAPHOC - NAMSINH >= 18);

